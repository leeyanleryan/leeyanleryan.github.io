<div id="test-container" style="margin-top:1.5em;">
  <!-- JS will populate this -->
</div>
<button id="quiz-next" style="margin-top:1em;">Next Question</button>
<script>
  // 1) Build a JS array of only those lines that have explanations
  window._lyricsTestData = [
    {% for line in page.lyrics %}
      {% if line.explanation and line.explanation.size > 0 %}
      {
        kanji:   {{ line.kanji | jsonify }},
        romaji:  {{ line.romaji | jsonify }},
        english: {{ line.english | jsonify }},
        explanations: [
          {% assign valid_expls = "" | split: "," %}
          {% for item in line.explanation %}
            {% assign entry = site.data.word-bank-jp[item.text] %}
            {% if entry %}
              {% assign valid_expls = valid_expls | push: item %}
            {% endif %}
          {% endfor %}
          {% for item in valid_expls %}
            {
              word: {{ item.text | jsonify }},
              {% assign entry = site.data.word-bank-jp[item.text] %}
              {%- if entry.senses -%}
                {%- comment -%}pick sense_key logic…{%- endcomment -%}
                {% assign sense_key = item.sense %}
                {% if sense_key == nil %}
                  {% for pair in entry.senses %}
                    {% assign sense_key = pair[0] %}
                    {% break %}
                  {% endfor %}
                {% endif %}
                {% assign gloss_val = entry.senses[sense_key].english %}
              {% else %}
                {% assign gloss_val = entry.english %}
              {% endif %}
              gloss: {{ gloss_val | jsonify }}
            }{% unless forloop.last %},{% endunless %}
          {% endfor %}
        ]
      }{% if forloop.last == false %},{% endif %}
      {% endif %}
    {% endfor %}
  ];
</script>
<script>
  ;(() => {
    // 1) Grab the data once
    const data = window._lyricsTestData;
    if (!data.length) return;

    // 2) Utility
    function pick(arr) { return arr[Math.floor(Math.random()*arr.length)]; }

    // 3) The render function
    function renderQuestion() {
      const line = pick(data);
      const exp  = pick(line.explanations);

      // build distractors
      const others = data
        .flatMap(l => l.explanations.map(e => e.gloss))
        .filter(g => g && g !== exp.gloss);

      const numChoices    = 4;
      const numDistractors = numChoices - 1;

      // build a unique pool of wrong glosses
      const uniqueOthers = Array.from(new Set(
        data.flatMap(l => l.explanations.map(e => e.gloss))
          .filter(g => g && g !== exp.gloss)
      ));

      // shuffle & take as many as you can up to numDistractors
      const distractors = uniqueOthers
        .sort(() => Math.random() - 0.5)
        .slice(0, numDistractors);

      const options = [exp.gloss, ...distractors]
        .sort(() => Math.random() - 0.5);

      // render into container
      const container = document.getElementById('test-container');
      container.innerHTML = `
        <h4>
          Sentence:
          <span class="test-sentence">
            ${line.kanji.replace(
              exp.word,
              `<span class="highlight">${exp.word}</span>`
            )}
          </span>
        </h4>
        <ul class="test-options">
          ${options.map(opt =>
            `<li><button class="opt-btn"><h5 style="margin: 3px 0;">${opt}</h5></button></li>`
          ).join('')}
        </ul>
      `;

      // wire up the newly‐inserted buttons
      const buttons = container.querySelectorAll('.opt-btn');
      buttons.forEach(btn => {
        btn.disabled = false;
        btn.classList.remove('correct','incorrect');
        btn.addEventListener('click', () => {
          buttons.forEach(b => b.disabled = true);
          buttons.forEach(b => {
            if (b.textContent === exp.gloss) b.classList.add('correct');
          });
          if (btn.textContent !== exp.gloss) btn.classList.add('incorrect');
        });
      });
    }

    // 4) Initial draw
    renderQuestion();

    // 5) “Next” button hooks into it
    document.getElementById('quiz-next')
            .addEventListener('click', renderQuestion);

  })();
</script>